name: render

on:
  workflow_dispatch:
    inputs:
      lang:
        description: "Idioma: pt | en | es | pl | all"
        required: false
        default: "all"
      dry_run:
        description: "Somente renderizar (não publicar)? true|false"
        required: false
        default: "false"
  schedule:
    # Rode todo dia às 06:10 UTC (03:10 BRT). Ajuste se quiser.
    - cron: "10 6 * * *"

concurrency:
  group: render-${{ github.ref }}
  cancel-in-progress: false

jobs:
  render:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    env:
      # Secrets (já criados por você)
      DRIVE_ROOT_FOLDER_ID: ${{ secrets.DRIVE_ROOT_FOLDER_ID }}
      SERVICE_ACCOUNT_JSON: ${{ secrets.SERVICE_ACCOUNT_JSON }}
      SHEET_ID: ${{ secrets.SHEET_ID }}
      OAUTH_CLIENT_ID: ${{ secrets.OAUTH_CLIENT_ID }}
      OAUTH_CLIENT_SECRET: ${{ secrets.OAUTH_CLIENT_SECRET }}
      OAUTH_REFRESH_TOKEN: ${{ secrets.OAUTH_REFRESH_TOKEN }}

      # Inputs (opcionais)
      LANG_INPUT: ${{ github.event.inputs.lang }}
      DRY_RUN: ${{ github.event.inputs.dry_run }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: System deps (FFmpeg + ImageMagick)
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg imagemagick

      - name: Python deps
        run: |
          python -m pip install --upgrade pip
          pip install google-api-python-client google-auth google-auth-httplib2 google-auth-oauthlib \
                     moviepy gTTS pydub Pillow numpy pytz

      - name: Materializar credencial de serviço
        run: |
          echo "$SERVICE_ACCOUNT_JSON" > sa.json
        shell: bash

      - name: Executar renderer
        env:
          SA_FILE: sa.json
        run: |
          # Se o script aceitar flags, passe aqui; caso não aceite, ele será ignorado sem erro.
          # Ex.: --lang "$LANG_INPUT" --dry-run "$DRY_RUN"
          python scripts/worker.py
